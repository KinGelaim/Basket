
<!DOCTYPE html>
<html lang="ru-RU" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://devburn.ru/xmlrpc.php">

<link rel='stylesheet' href='/wp-includes/css/prism.css' type='text/css' media='all' />
<script type="text/javascript" src="https://ff.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=ePAUCOzheNg2KhC4JH0FqGrVM1Pog__FeTMNnLjIM4FLLahIDu334aRDVVdv7LyTNsykrKMkXuSpEXh0GzIVJWeTjsnTBfrgOuz2Ktm95z17wSxfMYYdrkUY2aCdk1fNt48Syr5TxOgvw7kFQ_MAQ7aJP68Z3ZW34ryRTfoYxyC1cx3Dk7yG1F6RoJvBVYuzOsYolCZmKgkZD5kC2C7LML8FvjwUBnxy61DeVLJWXVWp2cPANxx5NOah5NRNeXRcGQA1KrgPa1VGBdDaDE50fw" charset="UTF-8"></script><script type='text/javascript' src='/wp-includes/js/prism.js'></script>

<title>WebGL Урок 14 - Блики и загрузка JSON-модели - DevBurn</title>

<!-- This site is optimized with the Yoast SEO plugin v7.1 - https://yoast.com/wordpress/plugins/seo/ -->
<link rel="canonical" href="https://devburn.ru/webgl-%d1%83%d1%80%d0%be%d0%ba-14-%d0%b1%d0%bb%d0%b8%d0%ba%d0%b8-%d0%b8-%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b7%d0%ba%d0%b0-json-%d0%bc%d0%be%d0%b4%d0%b5%d0%bb%d0%b8/" />
<meta property="og:locale" content="ru_RU" />
<meta property="og:type" content="article" />
<meta property="og:title" content="WebGL Урок 14 - Блики и загрузка JSON-модели - DevBurn" />
<meta property="og:description" content="Урок 15 &gt;&gt; &gt;" />
<meta property="og:url" content="https://devburn.ru/webgl-%d1%83%d1%80%d0%be%d0%ba-14-%d0%b1%d0%bb%d0%b8%d0%ba%d0%b8-%d0%b8-%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b7%d0%ba%d0%b0-json-%d0%bc%d0%be%d0%b4%d0%b5%d0%bb%d0%b8/" />
<meta property="og:site_name" content="DevBurn" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="Урок 15 &gt;&gt; &gt;" />
<meta name="twitter:title" content="WebGL Урок 14 - Блики и загрузка JSON-модели - DevBurn" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="DevBurn &raquo; Лента" href="https://devburn.ru/feed/" />
<link rel="alternate" type="application/rss+xml" title="DevBurn &raquo; Лента комментариев" href="https://devburn.ru/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="DevBurn &raquo; Лента комментариев к &laquo;WebGL Урок 14 &#8212; Блики и загрузка JSON-модели&raquo;" href="https://devburn.ru/webgl-%d1%83%d1%80%d0%be%d0%ba-14-%d0%b1%d0%bb%d0%b8%d0%ba%d0%b8-%d0%b8-%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b7%d0%ba%d0%b0-json-%d0%bc%d0%be%d0%b4%d0%b5%d0%bb%d0%b8/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.4\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.4\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/devburn.ru\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.3"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55357,56692,8205,9792,65039],[55357,56692,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='ample-bxslider-css'  href='https://devburn.ru/wp-content/themes/ample/js/jquery.bxslider/jquery.bxslider.css?ver=4.0' type='text/css' media='all' />
<link rel='stylesheet' id='ample-google-fonts-css'  href='//fonts.googleapis.com/css?family=Roboto%3A400%2C300&#038;ver=4.9.3' type='text/css' media='all' />
<link rel='stylesheet' id='ample-fontawesome-css'  href='https://devburn.ru/wp-content/themes/ample/font-awesome/css/font-awesome.min.css?ver=4.2.0' type='text/css' media='all' />
<link rel='stylesheet' id='ample-style-css'  href='https://devburn.ru/wp-content/themes/ample/style.css?ver=4.9.3' type='text/css' media='all' />
<script type='text/javascript' src='https://devburn.ru/wp-includes/js/jquery/jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='https://devburn.ru/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<link rel='https://api.w.org/' href='https://devburn.ru/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://devburn.ru/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://devburn.ru/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.9.3" />
<link rel='shortlink' href='https://devburn.ru/?p=108' />
<link rel="alternate" type="application/json+oembed" href="https://devburn.ru/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fdevburn.ru%2Fwebgl-%25d1%2583%25d1%2580%25d0%25be%25d0%25ba-14-%25d0%25b1%25d0%25bb%25d0%25b8%25d0%25ba%25d0%25b8-%25d0%25b8-%25d0%25b7%25d0%25b0%25d0%25b3%25d1%2580%25d1%2583%25d0%25b7%25d0%25ba%25d0%25b0-json-%25d0%25bc%25d0%25be%25d0%25b4%25d0%25b5%25d0%25bb%25d0%25b8%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://devburn.ru/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fdevburn.ru%2Fwebgl-%25d1%2583%25d1%2580%25d0%25be%25d0%25ba-14-%25d0%25b1%25d0%25bb%25d0%25b8%25d0%25ba%25d0%25b8-%25d0%25b8-%25d0%25b7%25d0%25b0%25d0%25b3%25d1%2580%25d1%2583%25d0%25b7%25d0%25ba%25d0%25b0-json-%25d0%25bc%25d0%25be%25d0%25b4%25d0%25b5%25d0%25bb%25d0%25b8%2F&#038;format=xml" />
		<style type="text/css" id="wp-custom-css">
			/*
Здесь можно добавить ваши CSS-стили.

Нажмите на значок помощи выше, чтобы узнать больше.
*/

.webglFundArticle {
	float: left;
	width:100%;
}

.webglFundArticle img {
	box-shadow: 0 0 10px rgba(0,0,0,0.5);
	float: left;
	margin-right: 1em;
}

.webglFundArticle p {
	text-align: justify;
	margin-top: 1.5em;
}

.webglFundSection {
	float: left;
	margin-top: 2em;
	width:100%;
}

.webglFundSection h2 {
	padding: 0;
}		</style>
	</head>

<body class="page-template page-template-page-templates page-template-template-webgl-lesson page-template-page-templatestemplate-webgl-lesson-php page page-id-108  wide">
   <div id="page" class="hfeed site">
   <header id="masthead" class="site-header" role="banner">
      <div class="header">
         
         <div class="main-head-wrap inner-wrap clearfix">
            <div id="header-left-section">
                                 <div id="header-text">
                     <h1 id="site-title">
                        <a href="https://devburn.ru/" title="DevBurn" rel="home">DevBurn</a>
                     </h1>
                     <h2 id="site-description">О разработке и не только&#8230;</h2>
                  </div>
                           </div>

            <div id="header-right-section">
               <nav id="site-navigation" class="main-navigation" role="navigation">
                  <h3 class="menu-toggle"></h3>
                  <div class="menu-%d0%b3%d0%bb%d0%b0%d0%b2%d0%bd%d0%be%d0%b5-%d0%bc%d0%b5%d0%bd%d1%8e-container"><ul id="menu-%d0%b3%d0%bb%d0%b0%d0%b2%d0%bd%d0%be%d0%b5-%d0%bc%d0%b5%d0%bd%d1%8e" class="menu menu-primary-container"><li id="menu-item-808" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-808"><a href="https://devburn.ru/2017/04/22/%d0%be%d1%81%d0%bd%d0%be%d0%b2%d1%8b-webgl-%d0%bd%d0%b0-%d1%80%d1%83%d1%81%d1%81%d0%ba%d0%be%d0%bc/">Основы WebGL</a></li>
<li id="menu-item-153" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-153"><a href="https://devburn.ru/%d1%83%d1%80%d0%be%d0%ba%d0%b8-webgl/">Уроки WebGL</a></li>
</ul></div>               </nav>
               <i class="fa fa-search search-top"></i>
               <div class="search-form-top">
                  
<form action="https://devburn.ru/" class="search-form searchform clearfix" method="get">
   <div class="search-wrap">
      <input type="text" placeholder="Поиск" class="s field" name="s">
      <button class="search-icon" type="submit"></button>
   </div>
</form><!-- .searchform -->               </div>
   	      </div>
   	   </div><!-- .main-head-wrap -->
           	   </div><!-- .header -->
	</header><!-- end of header -->
   <div class="main-wrapper">

               <div class="header-post-title-container clearfix">
            <div class="inner-wrap">
               <div class="post-title-wrapper">
                  <h1 class="header-post-title-class entry-title">WebGL Урок 14 &#8212; Блики и загрузка JSON-модели</h1>
               </div>
                           </div>
         </div>
     
   <div class="single-page clearfix">
      <div class="inner-wrap">
         <div id="primary">
            <div id="content">

               
                  
<article id="post-108" class="post-108 page type-page status-publish hentry">
   
   <div class="entry-content">
      <p>
<a style="float: right;" href="/webgl-урок-15-карта-отражений/">Урок 15 >></a>
<a href="/webgl-урок-13-попиксельное-освещение-и-неск/"><< Урок 13</a>
</p>
<p>
Материал в оригинале можно найти <a href="http://learningwebgl.com/blog/?p=1658">здесь</a>
</p>
<p>
Добро пожаловать на мой четырнадцатый урок по WebGL. В нем мы рассмотрим последний компонент <a href="https://ru.wikipedia.org/wiki/%D0%97%D0%B0%D1%82%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE_%D0%A4%D0%BE%D0%BD%D0%B3%D1%83">модели затенения по Фонгу</a>, которую мы рассматривали в <a href="/webgl-урок-7-основы-фонового-и-направленног/">седьмом уроке</a> &#8212; блики. Отблески на блестящих поверхностях, которые делают сцену более реалистичной.
</p>
<p>
Вот как выглядит результат урока в браузере с поддержкой WebGL:
</p>
<iframe width="420" height="315" src="https://www.youtube.com/embed/OSjVRA2BQJU" frameborder="0" allowfullscreen></iframe>
<p>
<a href="/webgl-урок-14-демо/">Здесь</a> можно посмотреть онлайн-демонстрацию, если ваш браузер поддерживает WebGL. <a href="/урок-0-приступаем-к-работе-с-webgl/">Здесь</a> можно узнать, что делать, если браузер не поддерживает WebGL. Вы увидите вращающийся <a href="https://ru.wikipedia.org/wiki/%D0%A7%D0%B0%D0%B9%D0%BD%D0%B8%D0%BA_%D0%AE%D1%82%D0%B0">чайник</a> с бликами на левой части корпуса и на ручке крышки. Также блики будут иногда появляться на носике и ручке, когда они будут находиться под подходящим углом к свету. Блики можно включать и отключать через соответствующую галочку, кроме того можно полностью отключить освещение и выбирать одну из трех доступных текстур: Отсутствует, Оцинкованный, которая используется по умолчанию (и которая является экземпляром под лицензией Creative Commons из замечательной коллекции <a href="http://www.arroway-textures.com/">Arroway Textures</a>) и (просто ради забавы) текстура планеты Земля (любезно предоставленной <a href="http://www.esa.int/About_Us/Welcome_to_ESA">Европейским космическим агентством</a>), которая смотрится по-странному привлекательной на чайнике :).
</p>
<p>
Еще вы можете регулировать силу блеска чайника с помощью текстового поля ниже &#8212; большие значения означают меньшие, более резкие блики &#8212; а также вы можете настраивать цвет бликов и, как и прежде, положение и рассеянный цвет точечного освещения, который и вызывает все эти эффекты. 
</p>
<p>
Теперь о том, как это все работает&#8230;
</p>
<p>
Уже обычное предупреждение: эти уроки ориентированы на людей с некоторым знанием программирования, но без опыта работы с 3D-графикой. С хорошим пониманием того, что происходит в коде, вы быстро начнете писать собственные 3D веб-страницы. Если вы не прочитали предыдущие уроки, возможно, вам следует сделать это перед чтением урока, где я буду объяснять лишь новые вещи. Урок основан на <a href="/webgl-урок-13-попиксельное-освещение-и-неск/">тринадцатом уроке</a>, поэтому вы должны хорошо понимать происходившие там вещи (и прошу оставлять комментарии, если вдруг что-то осталось неясным!).
</p>
<p>
Как и прежде здесь могут быть ошибки. Если встретите что-то некорректное, дайте мне знать и я постараюсь поскорей их исправить.
</p>
<p>
Вы можете посмотреть код этого примера двумя способами: посмотреть исходный код страницы с демонстрацией или, если вы используете GitHub, вы можете копировать урок (и другие уроки) из <a href="https://github.com/gpjt/webgl-lessons">репозитория</a>.
</p>
<p>
Теперь открывайте код в редакторе. Мы будем продвигаться сверху вниз, что нам очень подходит, потому что мы сразу видим фрагментный шейдер, в котором находятся самые интересные вещи. Перед тем, как мы в них углубимся, стоит сразу отметить небольшое отличие от кода в тринадцатом уроке: у нас больше нет шейдеров для вершинного освещения. Вообще говоря, вершинное освещение не особо хорошо справляется с бликами (так как они сразу распространяются по всей грани), поэтому не будем их использовать.
</p>
<p>
Итак, первым вы увидите фрагментный шейдер для попиксельного освещения. Он начинается с обычных объявлений varying-переменных и uniform-переменных, где появляются несколько новых объявлений (выделены красным) и одна &#8212; которая содержала цвет точечного освещения &#8212; была переименована, так как точечное освещение теперь имеет отражательный и рассеивающий компоненты.
</p>
<pre data-line="8-10,17">
<code class="language-javascript">
  precision mediump float;

  varying vec2 vTextureCoord;
  varying vec3 vTransformedNormal;
  varying vec4 vPosition;

  uniform float uMaterialShininess;

  uniform bool uShowSpecularHighlights;
  uniform bool uUseLighting;
  uniform bool uUseTextures;

  uniform vec3 uAmbientColor;

  uniform vec3 uPointLightingLocation;
  uniform vec3 uPointLightingSpecularColor;
  uniform vec3 uPointLighting</code><span class="redWord">Diffuse</span><code class="language-javascript">Color;

  uniform sampler2D uSampler;
</code>
</pre>
<p>
Они не нуждаются в объяснении. Через них значения из кода HTML попадают в шейдер для обработки. Перейдем к телу шейдера. Сначала здесь обрабатывается ситуация, когда освещение было отключено пользователем, и эта секция осталась без изменений:
</p>
<pre>
<code class="language-javascript">
  void main(void) {
    vec3 lightWeighting;
    if (!uUseLighting) {
      lightWeighting = vec3(1.0, 1.0, 1.0);
    } else {
</code>
</pre>
<p>
Теперь обрабатывается освещение, и здесь, конечно же, становится интересно:
</p>
<pre data-line="3-6">
<code class="language-javascript">
      vec3 lightDirection = normalize(uPointLightingLocation - vPosition.xyz);
      vec3 normal = normalize(vTransformedNormal);

      float specularLightWeighting = 0.0;
      if (uShowSpecularHighlights) {
</code>
</pre>
<p>
Итак, что же здесь происходит? Ну, мы вычисляем направление света, как и для привычного попиксельного освещения. Затем мы нормализуем вектор нормали фрагмента, как и прежде (вспомните, что при линейной интерполяции вершинных нормалей для создания фрагментных нормалей результатом вычисления не обязательно будет единичный вектор, поэтому нужна нормализация для исправления такой ситуации), но на этот раз мы будем использовать ее более интенсивно, а поэтому сохраняем ее в локальной переменной. Далее мы определяем коэффициент дополнительной яркости, которая будет проявляться по бликам. Если блики отключены, этот коэффициент равен, конечно же, нулю, но в противном случае мы должны рассчитать его.
</p>
<p>
Что же определяет яркость бликов? Как вы можете помнить из объяснения модели затенения Фонга из седьмого урока, блики получаются в результате отражения пучка света от поверхности, <a href="/webgl-урок-7-основы-фонового-и-направленног/#specular-explanation">как от зеркала</a>:
</p>
<blockquote>В этом случае пучок света отражается от поверхности под тем же углом, под которым он упал. Здесь яркость отраженного от материала света зависит от того, находятся ли ваши глаза на линии отраженного света. То есть не только от угла падения света на поверхность, но и от угла между вашей линией взгляда и поверхностью. Блики &#8212; это отблески и &#171;зайчики&#187; на объектах и степень отражения бликов меняется в зависимости от материала. Шершавое дерево будет плохо бликовать, в то время как отполированный металл очень хорошо.</blockquote>
<p>
Вот так выглядит уравнение для вычисления отраженного света:
</p>
<ul>
<li>(R<sub>m</sub> . V)<sup>α</sup></li>
</ul>
<p>
&#8230;где R<sub>m</sub> &#8212; это (нормализованный) вектор идеально отраженного луча света, который падает на рассматриваемую точку поверхности, V &#8212; это (тоже нормализованный) вектор направления взгляда пользователя, и, наконец, α &#8212; это константа, определяющая блеск &#8212; чем выше, тем ярче. Возможно, вы помните, что скалярное произведение двух векторов равно косинусу угла между ними. Это означает, что данная часть уравнения равна единице, если свет из источника будет отражен прямо на пользователя (то есть R<sub>m</sub> and V параллельны и поэтому угол между ними равен нулю, а косинус нуля равен единице) и затем свет будет становиться понемногу тусклее, когда угол падения луча будет отклоняться от пользователя. Возводя это значение в степень α, мы получим эффект &#171;сжатия&#187; &#8212; то есть при результате по-прежнему равном единице, когда вектора параллельны, он уменьшается быстрее в любую из сторон. Вы можете увидеть это в действии, если установите значение константы блеска на <a href="/webgl-урок-14-демо/">странице онлайн-демонстрации</a> во что-то большое &#8212; например, 512.
</p>
<p>
Принимая во внимание все вышеперечисленное, первым делом нам нужно рассчитать направление взгляда пользователя &#8212; V &#8212; и направление идеально отраженного луча света R<sub>m</sub>. Взглянем сначала на V, потому что это проще! Наша сцена находится в пространстве камеры, которую вы можете <a href="/webgl-урок-10-загрузка-мира-и-основы-камеры/#eye-space-explanation">вспомнить из десятого урока</a>. В сущности, это означает, что отрисовка сцены происходит, как-будто в координатах (0, 0, 0) находится камера, которая направлена в сторону убывания по оси Z, с осью X, увеличивающейся вправо, и Y, увеличивающейся вверх. Направление к любой точке из нулевых координат &#8212; это просто ее координаты, выраженные вектором. Аналогично, направление взгляда пользователя от любой точки к нулевым координатам &#8212; просто отрицательные значения координат. Координаты фрагмента, линейно интерполированные из вершинных координат, хранятся в vPosition, поэтому мы просто меняем им знак, нормализуем вектор до единичной длины &#8212; и все!
</p>
<pre data-line="2">
<code class="language-javascript">
        vec3 eyeDirection = normalize(-vPosition.xyz);
</code>
</pre>
<p>
Теперь взглянем на R<sub>m</sub>. Все было бы немного сложнее, если бы в GLSL не было функции reflect, которая определена следующим образом:
</p>
<blockquote>reflect (I, N): Для произвольного вектора I и направления поверхности N возвращает противоположное направление </blockquote>
<p>
Произвольным вектором в нашем случае будет направление, под которым луч света падает на фрагмент поверхности (которое у нас уже есть в виде lightDirection). Направление поверхности названо N, потому что это просто нормаль, которая у нас также уже есть. Теперь нам просто все рассчитать:
</p>
<pre data-line="2">
<code class="language-javascript">
        vec3 reflectionDirection = reflect(-lightDirection, normal);
</code>
</pre>
<p>
Теперь нам остался заключительный шаг, довольно простой после всего вышесказанного:
</p>
<pre data-line="2-3">
<code class="language-javascript">
        specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uMaterialShininess);
      }
</code>
</pre>
<p>
Это все, что нам нужно для вычисления доли бликов в освещении фрагмента. Следующим шагом будет вычисление доли рассеянного освещения, используя ту же логику, что была и раньше (хотя мы можем использовать нашу локальную переменную для нормализованной нормали):
</p>
<pre>
<code class="language-javascript">
      float diffuseLightWeighting = max(dot(</code><span class="redWord">normal</span><code class="language-javascript">, lightDirection), 0.0);
</code>
</pre>
<p>
Наконец, мы используем оба компонента &#8212; цвет рассеянного света и бликов &#8212; для вычисления общего освещения в этом фрагменте для каждой составляющей света. Это простое расширение того, что мы использовали раньше:
</p>
<pre data-line="3">
<code class="language-javascript">
      lightWeighting = uAmbientColor
        + uPointLightingSpecularColor * specularLightWeighting
        + uPointLighting</code><span class="redWord">Diffus</span><code class="language-javascript">eColor * diffuseLightWeighting;
    }
</code>
</pre>
<p>
После этого у нас есть значение для света, которое мы используем так же, как и в тринадцатом уроке, для нахождения цвета, определенного в текущей текстуре:
</p>
<pre>
<code class="language-javascript">
    vec4 fragmentColor;
    if (uUseTextures) {
      fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
    } else {
      fragmentColor = vec4(1.0, 1.0, 1.0, 1.0);
    }
    gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a);
  }
</code>
</pre>
<p>
Вот и весь фрагментный шейдер!
</p>
<p>
Теперь продвинемся немного ниже. Если вы будете искать отличия от тринадцатого урока, то заметите, что функция initShaders вернулась в ее раннюю простую форму, где создается лишь одна программа, хотя она дополнительно инициализирует одну-две uniform-переменных для настройки бликов. Еще дальше по направлению вниз идет initTextures, которая теперь загружает текстуры Земли и оцинкованной стали вместо Луны и ящика. А еще ниже setMatrixUniforms, где, как и в initShaders, мы вернулись к одной программе. И теперь мы подошли к чему-то более интересному.
</p>
<p>
Вместо initBuffers для создания буферов WebGL с различными вершинными атрибутами, определяющими внешний вид чайника, у нас появилось две функции: handleLoadedTeapot и loadTeapot. Подход вам уже знаком из <a href="/webgl-урок-10-загрузка-мира-и-основы-камеры/">десятого урока</a>, но стоит еще раз его осветить. Взглянем на loadTeapot (хотя она и появляется по коду второй):
</p>
<pre>
<code class="language-javascript">
  function loadTeapot() {
    var request = new XMLHttpRequest();
    request.open("GET", "Teapot.json");
    request.onreadystatechange = function() {
      if (request.readyState == 4) {
        handleLoadedTeapot(JSON.parse(request.responseText));
      }
    }
    request.send();
  }
</code>
</pre>
<p>
Общий вид должен быть вам знаком из десятого урока. Мы создаем новый объект XMLHttpRequest и используем его, чтобы загрузить файл Teapot.json. Этот процесс выполняется асинхронно, поэтому нам понадобится функция обратного вызова, которая будет срабатывать на разных этапах загрузки файла. При readyState равном 4, что означает окончание загрузки, начинает свою работу функция обратного вызова.
</p>
<p>
Теперь переходим к интересной части. Файл, который мы загрузили, имеет <a href="http://json.org/">формат JSON</a>, что означает, что он, по существу, уже написан на JavaScript. <a href="/wp-includes/webgl-lessons/lesson14/Teapot.json">Взгляните на него</a>, чтобы понять, о чем я говорю. Файл описывает объект JavaScript, содержащий массивы координат вершин, нормалей, текстурных координат и набора индексов вершин, которые полностью описывают чайник. Разумеется, мы могли бы хранить этот код прямо в index.html, но при построении более сложных моделей с множеством отдельных объектов вы бы предпочли поместить их в отдельные файлы.
</p>
<p>
(Какой именно формат использовать для готовых объектов в вашем приложении WebGL &#8212; это интересный вопрос. Модели могут быть созданы в одной из многочисленных программ, и эти программы могут хранить модели в множестве различных форматов, начиная от .obj и заканчивая 3DS. Похоже, что в будущем кто-то из них научится выводить модели в формате, понятному JavaScript, который вполне может быть похож на тот формат, который я использовал для чайника. А пока рассматривайте этот урок как пример загрузки готовой модели в формате JSON, но не как лучший из подходов 🙂
</p>
<p>
Итак, у нас есть код, который загружает JSON-файл и вызывает колбэк при завершении загрузки. В колбэке происходит преобразование текста в формате JSON в даные, которые мы сможем использовать. Мы могли бы просто использовать JavaScript-функцию eval для преобразования нашего текста в объект JavaScript, но на это обычно <a href="http://www.json.org/js.html">смотрят неодобрительно</a>, поэтому мы используем встроенную функцию JSON.parse для получения объекта. Далее мы передаем его в handleLoadedTeapot:
</p>
<pre>
<code class="language-javascript">
  var teapotVertexPositionBuffer;
  var teapotVertexNormalBuffer;
  var teapotVertexTextureCoordBuffer;
  var teapotVertexIndexBuffer;
  function handleLoadedTeapot(teapotData) {
    teapotVertexNormalBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, teapotVertexNormalBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(teapotData.vertexNormals), gl.STATIC_DRAW);
    teapotVertexNormalBuffer.itemSize = 3;
    teapotVertexNormalBuffer.numItems = teapotData.vertexNormals.length / 3;

    teapotVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, teapotVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(teapotData.vertexTextureCoords), gl.STATIC_DRAW);
    teapotVertexTextureCoordBuffer.itemSize = 2;
    teapotVertexTextureCoordBuffer.numItems = teapotData.vertexTextureCoords.length / 2;

    teapotVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, teapotVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(teapotData.vertexPositions), gl.STATIC_DRAW);
    teapotVertexPositionBuffer.itemSize = 3;
    teapotVertexPositionBuffer.numItems = teapotData.vertexPositions.length / 3;

    teapotVertexIndexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, teapotVertexIndexBuffer);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(teapotData.indices), gl.STATIC_DRAW);
    teapotVertexIndexBuffer.itemSize = 1;
    teapotVertexIndexBuffer.numItems = teapotData.indices.length;

    document.getElementById("loadingtext").textContent = "";
  }
</code>
</pre>
<p>
Здесь особо нечего объяснять &#8212; функция просто использует различные массивы загруженного объекта JSON и помещает их в массивы WebGL, которые затем передаются в видеокарту через созданные буферы. После всего этого мы очищаем элемент div в документе HTML, который до этого сообщал пользователю, что модель еще загружается &#8212; все как и в десятом уроке.
</p>
<p>
Итак, модель загружена. Что еще? Есть еще drawScene, которая отрисовывает чайник под заданным углом (после проверки, что он загружен), но ничего действительного нового там нет. Взгляните на код и убедитесь, что вы понимаете, что в нем происходит (и прошу вас оставлять комментарии, если что-то не понятно), но я сомневаюсь, что вас там что-то удивит.
</p>
<p>
Кроме того, animate содержит несколько незначительных изменений для вращения чайника вокруг своей оси вместо вращения Луны и ящика по орбите, а webGLStart вызывает loadTeapot вместо initBuffers. И, наконец, код HTML содержит DIV с соответствующими CSS-стилями, который отображает надпись &#171;Loading world…&#187; (загрузка мира), пока чайник грузится и еще новые поля ввода для параметров бликов.
</p>
<p>
И на этом все! Вы научились писать шейдеры, которые отображают блики, и загружать готовую модель из формата JSON. В следующий раз мы взглянем на кое-что более продвинутое &#8212; а именно на более интересный подход в использовании текстур с применением карты отражений.
</p>
<p>
<a style="float: right;" href="/webgl-урок-15-карта-отражений/">Урок 15 >></a>
<a href="/webgl-урок-13-попиксельное-освещение-и-неск/"><< Урок 13</a>
</p>
   </div>

   </article>
                  
<div id="comments" class="comments-area">

   
   
   
   	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Добавить комментарий <small><a rel="nofollow" id="cancel-comment-reply-link" href="/webgl-%D1%83%D1%80%D0%BE%D0%BA-14-%D0%B1%D0%BB%D0%B8%D0%BA%D0%B8-%D0%B8-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0-json-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D0%B8/#respond" style="display:none;">Отменить ответ</a></small></h3>			<form action="https://devburn.ru/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate>
				<p class="comment-notes"><span id="email-notes">Ваш e-mail не будет опубликован.</span> Обязательные поля помечены <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Комментарий</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Имя <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">E-mail <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Сайт</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Отправить комментарий" /> <input type='hidden' name='comment_post_ID' value='108' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="1f52e11015" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="108"/></p>			</form>
			</div><!-- #respond -->
	</div><!-- #comments -->                           </div>
                     </div>

         
<div id="secondary" class="sidebar">
   <section id="search-2" class="widget widget_search">
<form action="https://devburn.ru/" class="search-form searchform clearfix" method="get">
   <div class="search-wrap">
      <input type="text" placeholder="Поиск" class="s field" name="s">
      <button class="search-icon" type="submit"></button>
   </div>
</form><!-- .searchform --></section>		<section id="recent-posts-2" class="widget widget_recent_entries">		<h3 class="widget-title">Свежие записи</h3>		<ul>
											<li>
					<a href="https://devburn.ru/2018/04/01/%d1%81%d0%b8%d1%81%d1%82%d0%b5%d0%bc%d0%b0-%d1%87%d0%b0%d1%81%d1%82%d0%b8%d1%86/">Система частиц</a>
									</li>
											<li>
					<a href="https://devburn.ru/2017/04/22/%d0%be%d1%81%d0%bd%d0%be%d0%b2%d1%8b-webgl-%d0%bd%d0%b0-%d1%80%d1%83%d1%81%d1%81%d0%ba%d0%be%d0%bc/">Основы WebGL</a>
									</li>
											<li>
					<a href="https://devburn.ru/2016/09/18/%d1%81%d0%b8%d0%bc%d0%b2%d0%be%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-%d0%bf%d0%be%d0%bb%d0%b8%d0%b3%d0%be%d0%bd%d0%be%d0%b2-sld/">Символизация полигонов SLD</a>
									</li>
											<li>
					<a href="https://devburn.ru/2016/09/10/%d1%81%d0%b8%d0%bc%d0%b2%d0%be%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-%d0%bb%d0%b8%d0%bd%d0%b8%d0%b9-sld/">Символизация линий SLD</a>
									</li>
											<li>
					<a href="https://devburn.ru/2016/09/03/%d1%81%d0%b8%d0%bc%d0%b2%d0%be%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-%d1%82%d0%be%d1%87%d0%b5%d0%ba-sld/">Символизация точек SLD</a>
									</li>
					</ul>
		</section><section id="archives-2" class="widget widget_archive"><h3 class="widget-title">Архивы</h3>		<ul>
			<li><a href='https://devburn.ru/2018/04/'>Апрель 2018</a></li>
	<li><a href='https://devburn.ru/2017/04/'>Апрель 2017</a></li>
	<li><a href='https://devburn.ru/2016/09/'>Сентябрь 2016</a></li>
	<li><a href='https://devburn.ru/2016/06/'>Июнь 2016</a></li>
	<li><a href='https://devburn.ru/2016/04/'>Апрель 2016</a></li>
	<li><a href='https://devburn.ru/2016/03/'>Март 2016</a></li>
	<li><a href='https://devburn.ru/2016/02/'>Февраль 2016</a></li>
	<li><a href='https://devburn.ru/2016/01/'>Январь 2016</a></li>
	<li><a href='https://devburn.ru/2015/12/'>Декабрь 2015</a></li>
	<li><a href='https://devburn.ru/2015/10/'>Октябрь 2015</a></li>
	<li><a href='https://devburn.ru/2015/09/'>Сентябрь 2015</a></li>
	<li><a href='https://devburn.ru/2015/08/'>Август 2015</a></li>
	<li><a href='https://devburn.ru/2015/07/'>Июль 2015</a></li>
	<li><a href='https://devburn.ru/2015/05/'>Май 2015</a></li>
	<li><a href='https://devburn.ru/2015/04/'>Апрель 2015</a></li>
	<li><a href='https://devburn.ru/2015/03/'>Март 2015</a></li>
		</ul>
		</section><section id="categories-2" class="widget widget_categories"><h3 class="widget-title">Рубрики</h3>		<ul>
	<li class="cat-item cat-item-10"><a href="https://devburn.ru/category/threejs/" >threejs</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://devburn.ru/category/webgl/" >WebGL</a>
</li>
	<li class="cat-item cat-item-11"><a href="https://devburn.ru/category/%d0%b3%d0%b8%d1%81/" >ГИС</a>
</li>
	<li class="cat-item cat-item-7"><a href="https://devburn.ru/category/%d0%b8%d0%bd%d1%84%d0%be/" >Инфо</a>
</li>
		</ul>
</section><section id="text-2" class="widget widget_text"><h3 class="widget-title">Мои друзья</h3>			<div class="textwidget"><a target="_blank" href="http://pro-joomla.ru/">Бесплатные уроки Joomla!</a>
<br />
<a target="_blank" href="http://1centerprise8.blogspot.ru/">Полезные советы по 1С</a></div>
		</section></div>      </div><!-- .inner-wrap -->
   </div><!-- .single-page -->

         </div><!-- .main-wrapper -->

      <footer id="colophon">
         <div class="inner-wrap">
            

            <div class="footer-bottom clearfix">
               <div class="copyright-info">
                  <div class="copyright">Copyright &copy; 2020 <a href="https://devburn.ru/" title="DevBurn" ><span>DevBurn</span></a>. Powered by <a href="http://wordpress.org" target="_blank" title="WordPress"><span>WordPress</span></a>. Theme: Ample by <a href="http://themegrill.com/themes/ample" target="_blank" title="ThemeGrill" rel="designer"><span>ThemeGrill</span></a>.</div>               </div>

               <div class="footer-nav">
                              </div>
            </div>
         </div>
      </footer>
      <a href="#masthead" id="scroll-up"><i class="fa fa-angle-up"></i></a>
   </div><!-- #page -->
   <script type='text/javascript' src='https://devburn.ru/wp-includes/js/comment-reply.min.js?ver=4.9.3'></script>
<script type='text/javascript' src='https://devburn.ru/wp-content/themes/ample/js/theme-custom.js?ver=4.9.3'></script>
<script type='text/javascript' src='https://devburn.ru/wp-content/themes/ample/js/navigation.js?ver=4.9.3'></script>
<script type='text/javascript' src='https://devburn.ru/wp-includes/js/wp-embed.min.js?ver=4.9.3'></script>
<script async="async" type='text/javascript' src='https://devburn.ru/wp-content/plugins/akismet/_inc/form.js?ver=4.0.3'></script>
   <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-65619247-1', 'auto');
      ga('send', 'pageview');
    
    </script>
</body>
</html>